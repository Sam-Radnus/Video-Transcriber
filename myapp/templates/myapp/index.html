{% extends 'main.html' %}
{% block content %}

<div id="search_bar">
  <div>
    <h1>Video Transcriptor</h1>
  </div>
  <div class="input-group mb-3">
    <input id="yt_url" type="text" class="form-control" placeholder="Enter Video URL" aria-label="Recipient's username"
      aria-describedby="button-addon2">
    <button class="btn btn-outline-secondary" type="button" id="button-addon2">Search</button>
    <button class="btn btn-outline-primary" id="switch" type="button" id="button-addon2">Browse</button>
  </div>
  <div id="progressBar">
    <div id="progress"></div>
    <div id="progressText">0%</div>
  </div>
  <div>
    <div class="code-segment">
      <pre>
          <code>
            you will get your results here
          </code>
      </pre>
    </div>
  </div>
</div>
<script>

  const button = document.querySelector("#button-addon2");
  const input = document.querySelector("input.form-control");
  const text = document.querySelector("div div.code-segment pre code ");
  const progressBar = document.getElementById('progress');
  const progressBarContainer = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const startButton = document.getElementById('startButton');
  const toggle = document.getElementById('switch');
  toggle.addEventListener('click', () => {
    if (toggle.textContent === "Browse") {
      toggle.textContent = "URL";
      input.type = "file";
      input.setAttribute('accept', 'video/*');

    }
    else {
      input.removeAttribute('accept');
      toggle.textContent = "Browse"
      input.type = "text";
    }
  })
  function progress() {
    progressBarContainer.style.display = 'block';
    let progress = 0;
    const totalTime = 500000; // 50 seconds
    const intervalTime = 100;
    
    const interval = setInterval(() => {
      if (progress >= 100) {
        progress = 0;
        progressBar.style.width = `${progress}%`;
      }
      progress += intervalTime / totalTime * 100;
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${progress.toFixed(0)}%`;
    }, intervalTime);
  }
  button.addEventListener("click", () => {
    let url = document.getElementById('yt_url').value;
    text.textContent = "";
    progress();
    var is_file = toggle.textContent === "URL" ? true : false;
    if (is_file) {
      const file = input.files[0];
      console.log(file);
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          const formData = new FormData();
          formData.append('video_data', reader.result.split(',')[1]);

          fetch("http://127.0.0.1:8000/convert", {
          method: "POST",
          body: JSON.stringify({
            video_url: reader.result.split(',')[1],
            file: true
          }),
          headers: {
            "Content-Type": "application/json"
          }
        })
          .then(response => response.json())
          .then(data => {
            console.log(data);
            text.style.display = "block";
            progressBarContainer.style.display = 'none';
            text.textContent = data.text;
          })
          .catch(error => {

            console.error(error);
          });
        };
        reader.readAsDataURL(file);
      } else {
        console.log('No file selected');
        
      }
    }
    else{
     
        console.log(url)
        fetch("http://127.0.0.1:8000/convert", {
          method: "POST",
          body: JSON.stringify({
            video_url: url,
            file: false
          }),
          headers: {
            "Content-Type": "application/json"
          }
        })
          .then(response => response.json())
          .then(data => {
            console.log(data);
            text.style.display = "block";
            progressBarContainer.style.display = 'none';
            text.textContent = data.text;
          })
          .catch(error => {

            console.error(error);
          });
    }

  });



</script>
{% endblock content %}